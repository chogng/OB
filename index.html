<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OriginBridge</title>
  <style>
    :root {
      color-scheme: light dark;
    }

    body {
      font-family: 'Microsoft YaHei UI', 'Microsoft YaHei', system-ui, -apple-system, 'Segoe UI',
        Roboto, Arial, sans-serif;
      margin: 24px;
      line-height: 1.4;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono',
        'Courier New', monospace;
    }

    #pickedZipPath {
      display: inline-block;
      max-width: min(720px, 100%);
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      vertical-align: top;
    }

    .card {
      max-width: 860px;
      border: 1px solid rgba(127, 127, 127, 0.25);
      border-radius: 12px;
      padding: 18px 18px;
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }

    h2 {
      margin: 18px 0 8px 0;
      font-size: 14px;
    }

    p {
      margin: 8px 0;
    }

    .muted {
      opacity: 0.8;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .row>* {
      flex: 0 0 auto;
    }

    input[type='text'] {
      width: min(720px, 100%);
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(127, 127, 127, 0.35);
      background: transparent;
      color: inherit;
      outline: none;
    }

    button {
      font-family: inherit;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(127, 127, 127, 0.35);
      background: rgba(127, 127, 127, 0.12);
      color: inherit;
      cursor: pointer;
    }

    input,
    select {
      font-family: inherit;
    }

    button:hover {
      background: rgba(127, 127, 127, 0.18);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    label.checkbox {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      user-select: none;
    }

    select {
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid rgba(127, 127, 127, 0.35);
      background: transparent;
      color: inherit;
      outline: none;
    }

    .status {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(127, 127, 127, 0.25);
      background: rgba(127, 127, 127, 0.08);
      font-size: 12px;
      white-space: pre-wrap;
    }

    .status.error {
      border-color: rgba(220, 38, 38, 0.35);
      background: rgba(220, 38, 38, 0.08);
    }

    details {
      margin-top: 18px;
    }
  </style>
</head>

<body>
  <div class="card">




    <h2>Origin路径选择</h2>

    <div class="row" style="margin-top: 10px">
      <input id="originExe" type="text" placeholder="例如：C:\\Program Files\\OriginLab\\Origin2024\\Origin64.exe" />
      <button id="pickOriginExeBtn">选择 origin.exe</button>
      <button id="detectOriginExeBtn">自动检测</button>
      <button id="detectOriginExeDeepBtn" title="会递归扫描常见安装目录，可能较慢">深度扫描（慢）</button>
      <button id="saveOriginExeBtn">保存</button>
    </div>
    <div class="row" style="margin-top: 10px">
      <select id="originCandidates" style="display: none; min-width: 420px"></select>
    </div>

    <h2>保存设置</h2>
    <div class="row" style="margin-top: 10px">
      <span>保存路径：</span>
      <input id="savePath" type="text" placeholder="例如：C:\Users\lanxi\Documents\OriginBridge"
        value="C:\Users\lanxi\Documents\OriginBridge" style="flex: 1; max-width: 500px;" />
    </div>

    <h2>绘图设置</h2>
    <div class="row" style="margin-top: 10px">
      <label class="checkbox" title="勾选：复用同一个 Origin 窗口（更快；适合连续处理多个 ZIP）。不勾选：每个 ZIP 启动一个新的 Origin 窗口。">
        <input id="reuseOriginUi" type="checkbox" checked />
        单窗口模式（复用 Origin）
      </label>

      <span style="margin-left: 6px">绘图模式：</span>
      <select id="plotMode" title="多对 XY 时：同一图多曲线 / 每对一图（主要影响无 plot.json 的 CSV fallback）">
        <option value="single">同一图多曲线</option>
        <option value="multi">每对一图</option>
      </select>

      <span style="margin-left: 6px">引擎：</span>
      <select id="workerKind" title="自动：有 plot.json 优先 Python；否则 PowerShell。Python 需要 originpro 环境。">
        <option value="auto">自动</option>
        <option value="powershell">PowerShell（OGS/兼容）</option>
        <option value="python">Python（originpro）</option>
      </select>
    </div>

    <div class="row" style="margin-top: 10px">
      <span>模板(.otpu)：</span>
      <input id="templatePath" type="text" placeholder="（可选）选择 .otpu 图模板（仅 Python 引擎生效）"
        style="flex: 1; max-width: 500px;" />
      <button id="pickTemplateBtn">选择模板</button>
      <button id="clearTemplateBtn" title="恢复为不使用模板">清除</button>
    </div>


    <h2>ZIP 处理</h2>

    <div class="row" style="margin-top: 10px">
      <button id="pickZipBtn">选择 ZIP</button>
      <button id="extractZipBtn">打开origin</button>
      <span class="muted" style="font-size: 12px">已选：<code id="pickedZipPath">(未选择)</code></span>
    </div>

    <div id="status" class="status">Loading...</div>
  </div>

  <script type="module">
    import { invoke } from '@tauri-apps/api/core'
    import { open } from '@tauri-apps/plugin-dialog'

    const statusEl = document.getElementById('status')

    const originExeEl = document.getElementById('originExe')
    const pickOriginExeBtn = document.getElementById('pickOriginExeBtn')
    const detectOriginExeBtn = document.getElementById('detectOriginExeBtn')
    const detectOriginExeDeepBtn = document.getElementById('detectOriginExeDeepBtn')
    const saveOriginExeBtn = document.getElementById('saveOriginExeBtn')
    const originCandidatesEl = document.getElementById('originCandidates')

    const pickZipBtn = document.getElementById('pickZipBtn')
    const extractZipBtn = document.getElementById('extractZipBtn')

    const reuseOriginUiEl = document.getElementById('reuseOriginUi')
    const plotModeEl = document.getElementById('plotMode')
    const workerKindEl = document.getElementById('workerKind')
    const templatePathEl = document.getElementById('templatePath')
    const pickTemplateBtn = document.getElementById('pickTemplateBtn')
    const clearTemplateBtn = document.getElementById('clearTemplateBtn')

    const pickedZipPathEl = document.getElementById('pickedZipPath')
    const savePathEl = document.getElementById('savePath')

    let pickedZipPaths = []
    let isBusy = false

    const STORAGE_KEY_REUSE_ORIGIN_UI = 'originbridge.reuseOriginUi'
    const STORAGE_KEY_PLOT_MODE = 'originbridge.plotMode'
    const STORAGE_KEY_WORKER_KIND = 'originbridge.workerKind'
    const STORAGE_KEY_TEMPLATE_PATH = 'originbridge.templatePath'

    function loadBoolSetting(key, defaultValue) {
      try {
        const raw = localStorage.getItem(key)
        if (raw === null || raw === undefined || raw === '') return Boolean(defaultValue)
        const v = String(raw).trim().toLowerCase()
        return ['1', 'true', 'yes', 'y', 'on'].includes(v)
      } catch {
        return Boolean(defaultValue)
      }
    }

    function saveBoolSetting(key, v) {
      try {
        localStorage.setItem(key, v ? '1' : '0')
      } catch {
        // ignore
      }
    }

    function loadStrSetting(key, defaultValue) {
      try {
        const raw = localStorage.getItem(key)
        const s = String(raw || '').trim()
        return s || String(defaultValue || '')
      } catch {
        return String(defaultValue || '')
      }
    }

    function saveStrSetting(key, v) {
      try {
        localStorage.setItem(key, String(v || ''))
      } catch {
        // ignore
      }
    }

    if (reuseOriginUiEl) {
      reuseOriginUiEl.checked = loadBoolSetting(STORAGE_KEY_REUSE_ORIGIN_UI, true)
      reuseOriginUiEl.addEventListener('change', () =>
        saveBoolSetting(STORAGE_KEY_REUSE_ORIGIN_UI, Boolean(reuseOriginUiEl.checked))
      )
    }

    if (plotModeEl) {
      const v = loadStrSetting(STORAGE_KEY_PLOT_MODE, 'single').toLowerCase()
      plotModeEl.value = v === 'multi' ? 'multi' : 'single'
      plotModeEl.addEventListener('change', () => saveStrSetting(STORAGE_KEY_PLOT_MODE, plotModeEl.value))
    }

    if (workerKindEl) {
      const v = loadStrSetting(STORAGE_KEY_WORKER_KIND, 'auto').toLowerCase()
      workerKindEl.value = v === 'python' || v === 'powershell' ? v : 'auto'
      workerKindEl.addEventListener('change', () => saveStrSetting(STORAGE_KEY_WORKER_KIND, workerKindEl.value))
    }

    if (templatePathEl) {
      templatePathEl.value = loadStrSetting(STORAGE_KEY_TEMPLATE_PATH, '')
      templatePathEl.addEventListener('change', () => saveStrSetting(STORAGE_KEY_TEMPLATE_PATH, templatePathEl.value))
    }

    function normalizePickedPaths(selected) {
      if (!selected) return []
      if (Array.isArray(selected))
        return selected.map((p) => String(p || '').trim()).filter(Boolean)
      return [String(selected || '').trim()].filter(Boolean)
    }

    function formatPickedPathsForInline(paths) {
      const list = Array.isArray(paths) ? paths : []
      if (!list.length) return '(未选择)'
      if (list.length === 1) return list[0]
      const shown = list.slice(0, 3).join('\n')
      const suffix = list.length > 3 ? `\n…等 ${list.length} 个` : `\n共 ${list.length} 个`
      return shown + suffix
    }

    function setBusy(v) {
      isBusy = Boolean(v)
      for (const el of [
        pickOriginExeBtn,
        detectOriginExeBtn,
        detectOriginExeDeepBtn,
        saveOriginExeBtn,
        pickZipBtn,
        extractZipBtn,
        pickTemplateBtn,
        clearTemplateBtn,
        reuseOriginUiEl,
        plotModeEl,
        workerKindEl,
        templatePathEl,
      ]) {
        if (!el) continue
        el.disabled = isBusy
      }

      if (!isBusy) extractZipBtn.disabled = !pickedZipPaths.length
    }

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg
      statusEl.classList.toggle('error', Boolean(isError))
    }

    function setPickedZipPaths(paths) {
      pickedZipPaths = normalizePickedPaths(paths)
      pickedZipPathEl.textContent = formatPickedPathsForInline(pickedZipPaths)
      if (!isBusy) extractZipBtn.disabled = !pickedZipPaths.length
    }

    function getOriginExePath() {
      return (originExeEl.value || '').trim()
    }

    function setOriginCandidates(candidates) {
      const list = Array.isArray(candidates) ? candidates : []
      originCandidatesEl.innerHTML = ''

      if (list.length <= 1) {
        originCandidatesEl.style.display = 'none'
        return
      }

      for (const c of list) {
        const opt = document.createElement('option')
        const version = (c?.version || '').trim()
        const name = (c?.productName || '').trim()
        const labelParts = []
        if (name) labelParts.push(name)
        if (version) labelParts.push(version)
        const labelPrefix = labelParts.length ? labelParts.join(' ') + ' — ' : ''
        opt.value = c?.path || ''
        opt.textContent = labelPrefix + (c?.path || '')
        originCandidatesEl.appendChild(opt)
      }

      originCandidatesEl.selectedIndex = 0
      originCandidatesEl.style.display = ''
    }

    async function refreshOriginExePath() {
      if (!invoke) return
      try {
        const p = await invoke('get_origin_exe_path')
        originExeEl.value = p || ''
      } catch {
        // ignore
      }
    }

    async function saveOriginExePath() {
      if (!invoke) return
      const p = getOriginExePath()
      if (!p) {
        setStatus('请先填写或选择 Origin 可执行文件路径。', true)
        return
      }
      setBusy(true)
      try {
        const saved = await invoke('set_origin_exe_path', { path: p })
        originExeEl.value = saved || p
        setStatus('已保存 Origin 可执行文件：' + (saved || p))
      } catch (e) {
        setStatus(String(e?.message || e), true)
      } finally {
        setBusy(false)
      }
    }

    async function pickOriginExe() {
      if (!invoke) {
        setStatus('当前页面没有运行在 Tauri 应用内（只能在 OriginBridge 窗口里使用）。', true)
        return
      }
      setBusy(true)
      try {
        const selected = await open({
          directory: false,
          multiple: false,
          title: '选择 Origin 可执行文件（Origin64.exe/Origin.exe）',
          filters: [{ name: 'EXE', extensions: ['exe'] }],
        })

        if (!selected) {
          setStatus('未选择 Origin 可执行文件。')
          return
        }

        originExeEl.value = selected
        await saveOriginExePath()
      } catch (e) {
        setStatus(String(e?.message || e), true)
      } finally {
        setBusy(false)
      }
    }

    async function detectOriginExe(opts = {}) {
      if (!invoke) {
        setStatus('当前页面没有运行在 Tauri 应用内（只能在 OriginBridge 窗口里使用）。', true)
        return
      }
      const deepScan = Boolean(opts?.deepScan)
      setBusy(true)
      try {
        setStatus(deepScan ? '正在深度扫描 Origin 可执行文件…（可能较慢）' : '正在自动检测 Origin 可执行文件…')
        const candidates = await invoke('detect_origin_exe_candidates', { deepScan })
        const list = Array.isArray(candidates) ? candidates : []
        if (!list.length) {
          setOriginCandidates([])
          setStatus(deepScan ? '深度扫描未检测到 Origin 可执行文件，请手动选择。' : '未检测到 Origin 可执行文件，可尝试“深度扫描”或手动选择。', true)
          return
        }

        setOriginCandidates(list)
        originExeEl.value = list[0]?.path || ''
        if (list.length > 1) {
          setStatus(`检测到多个 Origin 版本，已默认选择最新版本（共 ${list.length} 个）。可在下拉框切换后点击保存。`)
        } else {
          setStatus('已检测到 Origin 可执行文件，已自动填入。点击保存以确认。')
        }
      } catch (e) {
        setOriginCandidates([])
        setStatus(String(e?.message || e), true)
      } finally {
        setBusy(false)
      }
    }

    async function pickZipForExtract() {
      if (!invoke) {
        setStatus('当前页面没有运行在 Tauri 应用内（只能在 OriginBridge 窗口里使用）。', true)
        return
      }

      setBusy(true)
      try {
        const selected = await open({
          directory: false,
          multiple: true,
          title: '选择要解压的 ZIP（可多选）',
          filters: [{ name: 'ZIP', extensions: ['zip'] }],
        })

        const list = normalizePickedPaths(selected)
        if (!list.length) {
          setStatus('未选择 ZIP。')
          return
        }

        setPickedZipPaths(list)
        setStatus(`已选择 ZIP：${list.length} 个\n` + list.join('\n'))
      } catch (e) {
        setStatus(String(e?.message || e), true)
      } finally {
        setBusy(false)
      }
    }

    async function pickTemplate() {
      if (!invoke) {
        setStatus('当前页面没有运行在 Tauri 应用内（只能在 OriginBridge 窗口里使用）。', true)
        return
      }
      setBusy(true)
      try {
        const selected = await open({
          directory: false,
          multiple: false,
          title: '选择 Origin 图模板（.otpu/.otp）',
          filters: [{ name: 'Origin Template', extensions: ['otpu', 'otp'] }],
        })
        if (!selected) {
          setStatus('未选择模板。')
          return
        }
        if (templatePathEl) templatePathEl.value = String(selected || '')
        saveStrSetting(STORAGE_KEY_TEMPLATE_PATH, String(selected || ''))
        setStatus('已选择模板：' + String(selected || ''))
      } catch (e) {
        setStatus(String(e?.message || e), true)
      } finally {
        setBusy(false)
      }
    }

    function clearTemplate() {
      if (templatePathEl) templatePathEl.value = ''
      saveStrSetting(STORAGE_KEY_TEMPLATE_PATH, '')
      setStatus('已清除模板。')
    }

    async function extractZip() {
      if (!invoke) {
        setStatus('当前页面没有运行在 Tauri 应用内（只能在 OriginBridge 窗口里使用）。', true)
        return
      }

      if (!getOriginExePath()) {
        setStatus('请先配置并保存 Origin 可执行文件路径。', true)
        return
      }

      if (!pickedZipPaths.length) {
        await pickZipForExtract()
        if (!pickedZipPaths.length) return
      }

      setBusy(true)
      try {
        const reuseOriginUi = Boolean(reuseOriginUiEl?.checked)
        const plotMode = String(plotModeEl?.value || 'single').trim().toLowerCase() === 'multi' ? 'multi' : 'single'
        const workerKindRaw = String(workerKindEl?.value || 'auto').trim().toLowerCase()
        const workerKind = workerKindRaw === 'python' || workerKindRaw === 'powershell' ? workerKindRaw : 'auto'
        const templatePath = String(templatePathEl?.value || '').trim()

        const results = []
        const zips = pickedZipPaths.slice()

        for (let i = 0; i < zips.length; i++) {
          const zipPath = zips[i]
          setStatus(`(${i + 1}/${zips.length}) 正在启动出图任务…\nZIP: ${zipPath}`)

          try {
            const savePath = (savePathEl.value || '').trim()
            const result = await invoke('extract_zip_and_open_origin', {
              zipPath,
              savePath,
              reuseOriginUi,
              plotMode,
              workerKind,
              templatePath: templatePath || null,
            })
            const ogsCount = Array.isArray(result?.ogsPaths) ? result.ogsPaths.length : 0
            const logHint = result?.logPath ? `\n日志: ${result.logPath}` : ''
            const errHint = result?.errorPath ? `\n错误文件: ${result.errorPath}` : ''
            results.push(
              `已解压并启动出图任务。\nZIP: ${zipPath}\n解压目录: ${result.extractDir}\nOGS: ${ogsCount ? `${ogsCount} 个` : '未找到'}${logHint}${errHint}`
            )
          } catch (e) {
            results.push(`启动失败。\nZIP: ${zipPath}\n错误: ${String(e?.message || e)}`)
          }
        }

        setStatus(
          results.join('\n\n') +
          '\n\n后台将执行出图任务，结果会显示在 Origin 窗口中。\n' +
          `模式：${reuseOriginUi ? '单窗口（复用 Origin）' : '多窗口（每个 ZIP 一个 Origin）'}\n` +
          `引擎：${workerKind}\n` +
          `绘图模式：${plotMode}\n` +
          `模板：${templatePath ? templatePath : '(无)'}\n\n` +
          '提示：默认不会自动清理工作/日志文件夹（.ob 会保留）。如需开启自动清理，设置 ORIGINBRIDGE_ENABLE_CLEANUP=1；如需保留用于排查，设置 ORIGINBRIDGE_KEEP_WORK=1（或 ORIGINBRIDGE_KEEP_TEMP=1）。'
        )
      } catch (e) {
        setStatus(String(e?.message || e), true)
      } finally {
        setBusy(false)
      }
    }

    pickZipBtn.addEventListener('click', pickZipForExtract)
    extractZipBtn.addEventListener('click', extractZip)
    pickOriginExeBtn.addEventListener('click', pickOriginExe)
    detectOriginExeBtn.addEventListener('click', () => detectOriginExe())
    detectOriginExeDeepBtn.addEventListener('click', () => detectOriginExe({ deepScan: true }))
    saveOriginExeBtn.addEventListener('click', saveOriginExePath)
    pickTemplateBtn?.addEventListener('click', pickTemplate)
    clearTemplateBtn?.addEventListener('click', clearTemplate)
    originCandidatesEl.addEventListener('change', () => {
      const v = originCandidatesEl.value || ''
      if (v) originExeEl.value = v
    })

    setPickedZipPaths([])
    refreshOriginExePath().finally(() => {
      if (!getOriginExePath()) setStatus('请先配置 Origin 可执行文件路径。', true)
      else setStatus('就绪。')
    })
  </script>
</body>

</html>
