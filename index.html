<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OriginBridge</title>
  <style>
    :root {
      color-scheme: light dark;
    }

    body {
      font-family: 'Microsoft YaHei UI', 'Microsoft YaHei', system-ui, -apple-system, 'Segoe UI',
        Roboto, Arial, sans-serif;
      margin: 24px;
      line-height: 1.4;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono',
        'Courier New', monospace;
    }

    #pickedZipPath {
      display: inline-block;
      max-width: min(720px, 100%);
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      vertical-align: top;
    }

    .card {
      max-width: 860px;
      border: 1px solid rgba(127, 127, 127, 0.25);
      border-radius: 12px;
      padding: 18px 18px;
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }

    h2 {
      margin: 18px 0 8px 0;
      font-size: 14px;
    }

    p {
      margin: 8px 0;
    }

    .muted {
      opacity: 0.8;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .row>* {
      flex: 0 0 auto;
    }

    .checkbox {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      user-select: none;
    }

    input[type='text'] {
      width: min(720px, 100%);
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(127, 127, 127, 0.35);
      background: transparent;
      color: inherit;
      outline: none;
    }

    button {
      font-family: inherit;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(127, 127, 127, 0.35);
      background: rgba(127, 127, 127, 0.12);
      color: inherit;
      cursor: pointer;
    }

    input,
    select {
      font-family: inherit;
    }

    button:hover {
      background: rgba(127, 127, 127, 0.18);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }



    details {
      margin-top: 18px;
    }
  </style>
</head>

<body>
  <div class="card">




    <h2>Origin路径选择</h2>

    <div class="row" style="margin-top: 10px">
      <input id="originExe" type="text" placeholder="例如：C:\\Program Files\\OriginLab\\Origin2024\\Origin64.exe" />
      <button id="pickOriginExeBtn">选择 origin.exe</button>
      <button id="detectOriginExeBtn">自动检测</button>
      <button id="detectOriginExeDeepBtn" title="会递归扫描常见安装目录，可能较慢">深度扫描（慢）</button>
      <button id="saveOriginExeBtn">保存</button>
    </div>
    <div class="row" style="margin-top: 10px">
      <select id="originCandidates" style="display: none; min-width: 420px"></select>
    </div>

    <h2>保存设置</h2>
    <div class="row" style="margin-top: 10px">
      <span>保存路径：</span>
      <input id="savePath" type="text" placeholder="例如：C:\Users\lanxi\Documents\OriginBridge"
        value="C:\Users\lanxi\Documents\OriginBridge" style="flex: 1; max-width: 500px;" />
      <button id="pickSavePathBtn">选择路径</button>
    </div>



    <h2>ZIP 处理</h2>

    <div class="row" style="margin-top: 10px">
      <button id="pickZipBtn">选择 ZIP</button>
      <button id="extractZipBtn">打开origin</button>
      <label class="checkbox" title="勾选：所有文件在同一个 Origin 窗口中处理。不勾选：每个文件启动一个新的 Origin 窗口。">
        <input id="multiZipReuseUi" type="checkbox" checked />
        单窗口模式
      </label>

    </div>


  </div>

  <script type="module">
    import { invoke } from '@tauri-apps/api/core'
    import { open } from '@tauri-apps/plugin-dialog'



    const originExeEl = document.getElementById('originExe')
    const pickOriginExeBtn = document.getElementById('pickOriginExeBtn')
    const detectOriginExeBtn = document.getElementById('detectOriginExeBtn')
    const detectOriginExeDeepBtn = document.getElementById('detectOriginExeDeepBtn')
    const saveOriginExeBtn = document.getElementById('saveOriginExeBtn')
    const originCandidatesEl = document.getElementById('originCandidates')

    const pickZipBtn = document.getElementById('pickZipBtn')
    const extractZipBtn = document.getElementById('extractZipBtn')
    const multiZipReuseUiEl = document.getElementById('multiZipReuseUi')


    const savePathEl = document.getElementById('savePath')
    const pickSavePathBtn = document.getElementById('pickSavePathBtn')

    let pickedZipPaths = []
    let isBusy = false

    const STORAGE_KEY_MULTI_ZIP_REUSE_UI = 'originbridge.multiZipReuseUi'

    function loadMultiZipReuseUiSetting() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_MULTI_ZIP_REUSE_UI)
        if (raw === null || raw === undefined || raw === '') return true
        return ['1', 'true', 'yes', 'y', 'on'].includes(String(raw).trim().toLowerCase())
      } catch {
        return true
      }
    }

    function saveMultiZipReuseUiSetting(v) {
      try {
        localStorage.setItem(STORAGE_KEY_MULTI_ZIP_REUSE_UI, v ? '1' : '0')
      } catch {
        // ignore
      }
    }

    if (multiZipReuseUiEl) {
      multiZipReuseUiEl.checked = loadMultiZipReuseUiSetting()
      multiZipReuseUiEl.addEventListener('change', () => {
        saveMultiZipReuseUiSetting(Boolean(multiZipReuseUiEl.checked))
      })
    }

    function normalizePickedPaths(selected) {
      if (!selected) return []
      if (Array.isArray(selected))
        return selected.map((p) => String(p || '').trim()).filter(Boolean)
      return [String(selected || '').trim()].filter(Boolean)
    }

    function formatPickedPathsForInline(paths) {
      const list = Array.isArray(paths) ? paths : []
      if (!list.length) return '(未选择)'
      if (list.length === 1) return list[0]
      const shown = list.slice(0, 3).join('\n')
      const suffix = list.length > 3 ? `\n…等 ${list.length} 个` : `\n共 ${list.length} 个`
      return shown + suffix
    }

    function setBusy(v) {
      isBusy = Boolean(v)
      for (const el of [
        pickOriginExeBtn,
        detectOriginExeBtn,
        detectOriginExeDeepBtn,
        saveOriginExeBtn,
        pickSavePathBtn,
        pickZipBtn,
        extractZipBtn,
        multiZipReuseUiEl,
      ])
        el.disabled = isBusy

      if (!isBusy) extractZipBtn.disabled = !pickedZipPaths.length
    }

    function setStatus(msg, isError = false) {
      if (isError) {
        console.error(msg)
      } else {
        console.log(msg)
      }
    }

    function setPickedZipPaths(paths) {
      pickedZipPaths = normalizePickedPaths(paths)
      // pickedZipPathEl.textContent = formatPickedPathsForInline(pickedZipPaths)
      if (!isBusy) extractZipBtn.disabled = !pickedZipPaths.length
    }

    function getOriginExePath() {
      return (originExeEl.value || '').trim()
    }

    function setOriginCandidates(candidates) {
      const list = Array.isArray(candidates) ? candidates : []
      originCandidatesEl.innerHTML = ''

      if (list.length <= 1) {
        originCandidatesEl.style.display = 'none'
        return
      }

      for (const c of list) {
        const opt = document.createElement('option')
        const version = (c?.version || '').trim()
        const name = (c?.productName || '').trim()
        const labelParts = []
        if (name) labelParts.push(name)
        if (version) labelParts.push(version)
        const labelPrefix = labelParts.length ? labelParts.join(' ') + ' — ' : ''
        opt.value = c?.path || ''
        opt.textContent = labelPrefix + (c?.path || '')
        originCandidatesEl.appendChild(opt)
      }

      originCandidatesEl.selectedIndex = 0
      originCandidatesEl.style.display = ''
    }

    async function refreshOriginExePath() {
      if (!invoke) return
      try {
        const p = await invoke('get_origin_exe_path')
        originExeEl.value = p || ''
      } catch {
        // ignore
      }
    }

    async function saveOriginExePath() {
      if (!invoke) return
      const p = getOriginExePath()
      if (!p) {
        setStatus('请先填写或选择 Origin 可执行文件路径。', true)
        return
      }
      setBusy(true)
      try {
        const saved = await invoke('set_origin_exe_path', { path: p })
        originExeEl.value = saved || p
        setStatus('已保存 Origin 可执行文件：' + (saved || p))
      } catch (e) {
        setStatus(String(e?.message || e), true)
      } finally {
        setBusy(false)
      }
    }

    async function pickOriginExe() {
      if (!invoke) {
        setStatus('当前页面没有运行在 Tauri 应用内（只能在 OriginBridge 窗口里使用）。', true)
        return
      }
      setBusy(true)
      try {
        const selected = await open({
          directory: false,
          multiple: false,
          title: '选择 Origin 可执行文件（Origin64.exe/Origin.exe）',
          filters: [{ name: 'EXE', extensions: ['exe'] }],
        })

        if (!selected) {
          setStatus('未选择 Origin 可执行文件。')
          return
        }

        originExeEl.value = selected
        await saveOriginExePath()
      } catch (e) {
        setStatus(String(e?.message || e), true)
      } finally {
        setBusy(false)
      }
    }

    async function detectOriginExe(opts = {}) {
      if (!invoke) {
        setStatus('当前页面没有运行在 Tauri 应用内（只能在 OriginBridge 窗口里使用）。', true)
        return
      }
      const deepScan = Boolean(opts?.deepScan)
      setBusy(true)
      try {
        setStatus(deepScan ? '正在深度扫描 Origin 可执行文件…（可能较慢）' : '正在自动检测 Origin 可执行文件…')
        const candidates = await invoke('detect_origin_exe_candidates', { deepScan })
        const list = Array.isArray(candidates) ? candidates : []
        if (!list.length) {
          setOriginCandidates([])
          setStatus(deepScan ? '深度扫描未检测到 Origin 可执行文件，请手动选择。' : '未检测到 Origin 可执行文件，可尝试“深度扫描”或手动选择。', true)
          return
        }

        setOriginCandidates(list)
        originExeEl.value = list[0]?.path || ''
        if (list.length > 1) {
          setStatus(`检测到多个 Origin 版本，已默认选择最新版本（共 ${list.length} 个）。可在下拉框切换后点击保存。`)
        } else {
          setStatus('已检测到 Origin 可执行文件，已自动填入。点击保存以确认。')
        }
      } catch (e) {
        setOriginCandidates([])
        setStatus(String(e?.message || e), true)
      } finally {
        setBusy(false)
      }
    }

    async function pickZipForExtract() {
      if (!invoke) {
        setStatus('当前页面没有运行在 Tauri 应用内（只能在 OriginBridge 窗口里使用）。', true)
        return
      }

      setBusy(true)
      try {
        const selected = await open({
          directory: false,
          multiple: true,
          title: '选择要解压的 ZIP（可多选）',
          filters: [{ name: 'ZIP', extensions: ['zip'] }],
        })

        const list = normalizePickedPaths(selected)
        if (!list.length) {
          setStatus('未选择 ZIP。')
          return
        }

        setPickedZipPaths(list)
        setStatus(`已选择 ZIP：${list.length} 个\n` + list.join('\n'))
      } catch (e) {
        setStatus(String(e?.message || e), true)
      } finally {
        setBusy(false)
      }
    }

    async function pickSavePath() {
      if (!invoke) {
        setStatus('当前页面没有运行在 Tauri 应用内（只能在 OriginBridge 窗口里使用）。', true)
        return
      }
      setBusy(true)
      try {
        const selected = await open({
          directory: true,
          multiple: false,
          title: '选择保存路径',
          defaultPath: savePathEl.value || undefined,
        })

        if (!selected) return

        savePathEl.value = selected
      } catch (e) {
        setStatus(String(e?.message || e), true)
      } finally {
        setBusy(false)
      }
    }

    async function extractZip() {
      if (!invoke) {
        setStatus('当前页面没有运行在 Tauri 应用内（只能在 OriginBridge 窗口里使用）。', true)
        return
      }

      if (!getOriginExePath()) {
        setStatus('请先配置并保存 Origin 可执行文件路径。', true)
        return
      }

      if (!pickedZipPaths.length) {
        await pickZipForExtract()
        if (!pickedZipPaths.length) return
      }

      const reuseOriginUi = Boolean(multiZipReuseUiEl?.checked)

      setBusy(true)
      try {
        const results = []
        const zips = pickedZipPaths.slice()

        for (let i = 0; i < zips.length; i++) {
          const zipPath = zips[i]
          setStatus(`(${i + 1}/${zips.length}) 正在启动出图任务…\nZIP: ${zipPath}`)

          try {
            const savePath = (savePathEl.value || '').trim()
            const result = await invoke('extract_zip_and_open_origin', {
              zipPath,
              savePath,
              reuseOriginUi,
            })
            const ogsCount = Array.isArray(result?.ogsPaths) ? result.ogsPaths.length : 0
            const logHint = result?.logPath ? `\n日志: ${result.logPath}` : ''
            const errHint = result?.errorPath ? `\n错误文件: ${result.errorPath}` : ''
            results.push(
              `已解压并启动出图任务。\nZIP: ${zipPath}\n解压目录: ${result.extractDir}\nOGS: ${ogsCount ? `${ogsCount} 个` : '未找到'}${logHint}${errHint}`
            )
          } catch (e) {
            results.push(`启动失败。\nZIP: ${zipPath}\n错误: ${String(e?.message || e)}`)
          }
        }

        setStatus(
          results.join('\n\n') +
          '\n\n后台将自动执行 OGS 并保存 .opju，然后用 Origin 打开该项目。\n\n提示：默认不会自动清理工作/日志文件夹（.ob 会保留）。如需开启自动清理，设置 ORIGINBRIDGE_ENABLE_CLEANUP=1；如需保留用于排查，设置 ORIGINBRIDGE_KEEP_WORK=1（或 ORIGINBRIDGE_KEEP_TEMP=1）。'
        )
      } catch (e) {
        setStatus(String(e?.message || e), true)
      } finally {
        setBusy(false)
      }
    }

    pickSavePathBtn.addEventListener('click', pickSavePath)
    pickZipBtn.addEventListener('click', pickZipForExtract)
    extractZipBtn.addEventListener('click', extractZip)
    pickOriginExeBtn.addEventListener('click', pickOriginExe)
    detectOriginExeBtn.addEventListener('click', () => detectOriginExe())
    detectOriginExeDeepBtn.addEventListener('click', () => detectOriginExe({ deepScan: true }))
    saveOriginExeBtn.addEventListener('click', saveOriginExePath)
    originCandidatesEl.addEventListener('change', () => {
      const v = originCandidatesEl.value || ''
      if (v) originExeEl.value = v
    })

    setPickedZipPaths([])
    refreshOriginExePath().finally(() => {
      if (!getOriginExePath()) setStatus('请先配置 Origin 可执行文件路径。', true)
      else setStatus('就绪。')
    })
  </script>
</body>

</html>